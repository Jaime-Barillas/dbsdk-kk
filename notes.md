# Notes

## Compiling Koka to Wasm Without --fstdalloc

mimalloc requires sbrk but seems to not #include the unistd.h header it is
defined in. The #include is required in src/prim/wasi/prim.c at line ~41 before
`mi_memory_grow`. mimalloc seems to crash in Wasmer/Wasmtime with
`--heap=16MiB` and a default stack size. Setting the stack size to 4MiB helps
but still displays a warning. This warning starts showing up at a heap size of
40MiB.

## Extra `emcc` Arguments Used in the C/C++ CMake File

+ -s WASM=1
+ -s WASM\_BIGINT
+ -s NO\_FILESYSTEM=1
+ -s ERROR\_ON\_UNDEFINED\_SYMBOLS=0
+ -s WARN\_ON\_UNDEFINED\_SYMBOLS=0
+ -s EXPORTED\_FUNCTIONS=['_main','_malloc','_free']  
Also use these Koka options:
+ --heap=16MB - Wasm crashes unless stack is set as below.
+ --stack=65536 - Seems to default to half of heap. That crashes though, this
  amount just results in one warning.

## `emcc` Arguments Used by Koka

The test Koka file:
```
fun main()
  return ()
```
Compiled with: `koka -v2 -O0 --cc=emcc --target=wasm32 --sharedir=../../sys main.kk`.
Results in the below (plus sections for kklib and the std-library.)
```
codegen main
generate c: .koka/v2.4.2/emcc-wasm32-debug/main
shell> emcc -Wall -Wextra -Wpointer-arith -Wshadow -Wstrict-aliasing -Wno-unknown-pragmas
       -Wno-missing-field-initializers -Wno-unused-parameter -Wno-unused-variable
       -Wno-unused-value -Wno-unused-but-set-variable
       -g -O1 -c -D__wasi__ -I ../../sys/kklib/include -DKK_MIMALLOC=4
       -o .koka/v2.4.2/emcc-wasm32-debug/main.o
       .koka/v2.4.2/emcc-wasm32-debug/main.c

linking: main
shell> emcc -g -O1 -o .koka/v2.4.2/emcc-wasm32-debug/main.wasm
       .koka/v2.4.2/emcc-wasm32-debug/kklib.o
       .koka/v2.4.2/emcc-wasm32-debug/std_core_types.o
       .koka/v2.4.2/emcc-wasm32-debug/std_core_hnd.o
       .koka/v2.4.2/emcc-wasm32-debug/std_core.o
       .koka/v2.4.2/emcc-wasm32-debug/main.o
       -s TOTAL_STACK=8388608 -s TOTAL_MEMORY=1073741824 -lm -lpthread

created: .koka\v2.4.2\emcc-wasm32-debug\main.wasm       
```
Note that the debug information can be turned off by adding a `-g0` link arg.

## Which Libraries Need the Wasi Functions?

The wasm module was stripped with `wasm-strip -k name <wasm-file>`. NOTE: I
don't know what the 'name' custom section is for so I've kept it in the
stripped module. It's really small compared to the code section so no biggie.

Decompile the wasm module with `wasm-decompile -o main.wasm.decompile <stripped-wasm>`.
From inspecting the decompiled wasm (relevant code starts at line 767):
+ `wasi_args_sizes_get`: `main_1` via `start` - Generated C code from user
  prog.
+ `wasi_args_get`: `main_1` via `start` - Generated C code from user prog.
+ `wasi_proc_exit`:
  * Exit: `exit` via `start`, `abort` via `assert_fail`.
  * mimalloc (a bunch of fns.)
+ `wasi_clock_time_get`:
  * `clock_gettime` from:
    - `emscripten_get_now` via `sched_yield` inside mimalloc.
    - `kk_timer_ticks_prim` via `kk_timer_ticks` via `kk_main_start`,
      `kk_main_end` NOTE: This is the code to handle the --kktime argument that
      get's compiled into all Koka programs (as part of kklib.)
    - mimalloc (a small bunch of fns.)
+ `wasi_clock_res_get`: `clock_getres` via `kk_timer_ticks_prim`.
+ `wasi_environ_sizes_get`: `emscripten_environ_constructor` via
  `wasm_call_ctors`
+ `wasi_environ_get`: `emscripten_environ_constructor` via `wasm_call_ctors`
+ `_wasi_fd_close`: `stdio_close` via _nothing_. Perhaps it's used by code that
  was removed by the compiler?
+ `_wasi_fd_read`: `stdio_read` via _nothing_.
+ `_wasi_fd_write`: `stdio_write` via _nothing_.
+ `_wasi_fd_seek`: `lseek` via `stdio_seek` via _nothing_.

## A Wasi Implementation for DreamBox

### args_sizes_get
Used by the C code generated by the Koka compiler. The corresponding logic can
be skipped by returning a non-zero value or specifying that zero args were
supplied.

### args_get
Used by the C code generated by the Koka compiler. With `args_sizes_get`
defined to return an arg count of zero, the call to this function should be
skipped.

### proc_exit
Used by lots of stuff. The custom implementation is traps execution.

### clock_time_get
Used by mimalloc and kklib. It seems they both only use the MONOTONIC clock.

### environ_sizes_get
Used by emscripten setup code. The corresponding logic can be skipped by
returning a non-zero value or specifying that there are zero environment vars.

### environ_get
Used by emscripten setup code. With `environ_sizes_get` defined to return an
env count of zero, the call to this function should be skipped.

## Generating an ISO 9660 Image on Linux
mkisofs/genisoimage is needed. On fedora, install the genisoimage package. Use
the following command:
```
# Or genisoimage
#    -iso-level 2: Try also -l, allow file names longer than 8+3. Needed since
#                  the .wasm file extension is longer than 3 chars.
#    -V: Set volume label (effectively the game name.)
#    -no-pad: Used for bootable images not games. Smaller file sizes.
mkisofs -iso-level 2 -V <volume-label> -no-pad -o <out-file> <folder-root>
```
